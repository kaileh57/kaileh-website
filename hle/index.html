<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Humanity's Last Exam Quiz</title>
    <!-- Add Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- MathJax Configuration and Loading -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          enableMenu: false,
          renderActions: {
            addMenu: [], // remove the menu
            checkLoading: [] // remove the loading message
          }
        },
        startup: {
          pageReady: () => {
            return MathJax.startup.defaultPageReady().then(() => {
              console.log('MathJax initial typesetting complete');
            });
          }
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
    
    <style>
    /* CSS Styles */
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --primary-dark: #3730a3;
      --secondary: #f97316;
      --background: #0f172a;
      --card-bg: #1e293b;
      --text: #f1f5f9;
      --text-light: #94a3b8;
      --border: #334155;
      --correct: #34d399;
      --correct-bg: #064e3b;
      --incorrect: #f87171;
      --incorrect-bg: #7f1d1d;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s ease;
      --radius: 8px;
    }

    /* Light theme variables */
    .light-theme {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --primary-dark: #3730a3;
      --secondary: #f97316;
      --background: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --correct: #10b981;
      --correct-bg: #d1fae5;
      --incorrect: #ef4444;
      --incorrect-bg: #fee2e2;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: var(--text);
      background-color: var(--background);
      transition: var(--transition);
    }

    .app {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header Styles */
    header {
      margin-bottom: 30px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .tagline {
      font-size: 1.1rem;
      color: var(--text-light);
      margin-bottom: 20px;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
    }

    #theme-toggle-btn {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    #theme-toggle-btn:hover {
      background-color: var(--border);
    }

    .sun-icon, .moon-icon {
      width: 24px;
      height: 24px;
    }

    .sun-icon {
      display: none;
    }

    .moon-icon {
      display: block;
    }

    .light-theme .sun-icon {
      display: block;
    }

    .light-theme .moon-icon {
      display: none;
    }

    /* Stats Container */
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      padding: 12px 20px;
      box-shadow: var(--shadow);
      flex: 1;
      min-width: 100px;
      text-align: center;
      transition: var(--transition);
    }

    .stat-label {
      display: block;
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .stat-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }

    /* Category Filter */
    .category-filter {
      margin-bottom: 20px;
    }

    .category-filter label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    #category-select {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background-color: var(--card-bg);
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }

    /* Loading */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Card Styles */
    .question-card {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 30px;
      transition: var(--transition);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: var(--primary);
      color: white;
    }

    .category-badge {
      font-weight: 600;
      font-size: 1rem;
      padding: 5px 10px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
    }

    .question-id {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .question-content {
      padding: 30px 20px;
      font-size: 1.1rem;
      border-bottom: 1px solid var(--border);
    }

    .question-text {
      margin-bottom: 20px;
      line-height: 1.8;
    }

    .image-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    #question-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Answer Section Styles */
    .answer-section {
      padding: 20px;
    }

    .multiple-choice {
      margin-bottom: 20px;
    }

    .choice-item {
      padding: 15px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      background-color: var(--card-bg);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .choice-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .choice-item.selected {
      border-color: var(--primary);
      background-color: rgba(79, 70, 229, 0.1);
    }

    .choice-item.correct {
      border-color: var(--correct);
      background-color: var(--correct-bg);
    }

    .choice-item.incorrect {
      border-color: var(--incorrect);
      background-color: var(--incorrect-bg);
    }

    .text-answer {
      margin-bottom: 20px;
    }

    .text-answer label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: var(--text);
    }

    .input-group {
      display: flex;
      gap: 10px;
    }

    #answer-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      background-color: var(--card-bg);
      color: var(--text);
      transition: var(--transition);
    }

    #answer-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }

    .btn {
      display: inline-block;
      padding: 12px 20px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn:disabled {
      background-color: var(--text-light);
      cursor: not-allowed;
      transform: none;
    }

    .btn.secondary {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn.secondary:hover {
      background-color: rgba(79, 70, 229, 0.1);
    }

    .btn.primary {
      background-color: var(--primary);
      color: white;
      width: 100%;
      margin-top: 15px;
    }

    /* Feedback Styles */
    .feedback {
      margin-top: 20px;
    }

    .result-message {
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: var(--radius);
    }

    .result-message.correct {
      background-color: var(--correct-bg);
      color: var(--correct);
    }

    .result-message.incorrect {
      background-color: var(--incorrect-bg);
      color: var(--incorrect);
    }

    .correct-answer {
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1.1rem;
    }

    .explanation-container {
      margin: 20px 0;
    }

    #show-explanation {
      width: 100%;
    }

    .explanation {
      margin: 15px 0;
      padding: 20px;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .explanation h3 {
      margin-bottom: 15px;
      color: var(--primary);
      font-weight: 600;
    }

    .rationale {
      line-height: 1.8;
      margin-bottom: 15px;
    }

    .author {
      margin-top: 15px;
      font-style: italic;
      font-size: 0.9rem;
      color: var(--text-light);
    }

    /* Error State */
    .error-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 40px;
      background-color: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .error-message svg {
      width: 50px;
      height: 50px;
      color: var(--incorrect);
      margin-bottom: 20px;
    }

    .error-message p {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: var(--text);
    }

    #retry-btn {
      background-color: var(--primary);
    }

    /* Footer Styles */
    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      color: var(--text-light);
      font-size: 0.9rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
      transition: var(--transition);
    }

    footer a:hover {
      text-decoration: underline;
      color: var(--primary-dark);
    }

    /* Responsive Styles */
    @media (max-width: 600px) {
      .app {
        padding: 15px;
      }
      
      header h1 {
        font-size: 2rem;
      }
      
      .stats-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .stat {
        width: 100%;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }

    /* Math rendering styles */
    .mjx-chtml {
      margin: 0 !important;
      padding: 0 !important;
      display: inline-block !important;
      line-height: 0 !important;
      text-indent: 0 !important;
      text-align: left !important;
      text-transform: none !important;
      letter-spacing: normal !important;
      word-spacing: normal !important;
      overflow-wrap: normal !important;
      white-space: nowrap !important;
      float: none !important;
      direction: ltr !important;
      max-width: none !important;
      max-height: none !important;
      min-width: 0 !important;
      min-height: 0 !important;
      border: 0 !important;
    }

    /* Animation for transitions */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .question-card {
      animation: fadeIn 0.3s ease-out;
    }

    /* New feature - Category tag list */
    .category-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }

    .category-tag {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 5px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .category-tag:hover {
      border-color: var(--primary);
      background-color: rgba(79, 70, 229, 0.1);
    }

    .category-tag.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Add submit button for multiple choice */
    #multiple-choice-submit {
      display: block;
      width: 100%;
      margin-top: 20px;
    }

    /* Set a reasonable min-height for choice items */
    .choice-item {
      min-height: 60px;
      display: flex;
      align-items: center;
    }

    /* Format choice letter and content separately */
    .choice-letter {
      font-weight: bold;
      min-width: 25px;
      margin-right: 10px;
    }
    
    .choice-content {
      flex: 1;
    }
    
    /* Add styles for long or complex multiple choice options */
    .choice-item.long-option {
      flex-direction: column;
      align-items: flex-start;
      padding: 15px 15px 20px 15px;
    }
    
    .choice-item.long-option .choice-letter {
      margin-bottom: 10px;
    }
    
    .choice-item.long-option .choice-content {
      width: 100%;
      line-height: 1.6;
    }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="header-content">
                <h1>Humanity's Last Exam</h1>
                <div class="theme-toggle">
                    <button id="theme-toggle-btn" aria-label="Toggle light mode">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m-9-9H2m17 0h1M5.6 5.6l.7.7m12.1-.7l-.7.7m-12.1 11.4l.7-.7m12.1.7l-.7-.7M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0z"/>
                        </svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <p class="tagline">Test your knowledge with extremely challenging questions</p>
            
            <div class="stats-container">
                <div class="stat">
                    <span class="stat-label">Questions</span>
                    <span id="questions-count" class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Correct</span>
                    <span id="correct-count" class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Accuracy</span>
                    <span id="accuracy" class="stat-value">0%</span>
                </div>
            </div>
            
            <div class="category-filter">
                <label for="category-select">Filter by category:</label>
                <div class="category-tags" id="category-tags">
                    <!-- Popular categories will be shown as tags -->
                </div>
                <select id="category-select">
                    <option value="all">All Categories</option>
                    <!-- Categories will be populated by JavaScript -->
                </select>
            </div>
        </header>

        <main id="quiz-container">
            <div id="loading" class="loading-container">
                <div class="loading-spinner"></div>
                <p>Loading questions...</p>
            </div>
            
            <div id="question-card" class="question-card" style="display: none;">
                <div class="card-header">
                    <div class="category-badge" id="category">Category</div>
                    <div class="question-id" id="question-id">ID: 000</div>
                </div>
                
                <div class="question-content">
                    <div id="question-text" class="question-text">Question text will appear here</div>
                    <div id="image-container" class="image-container" style="display: none;">
                        <img id="question-image" alt="Question visual">
                    </div>
                </div>
                
                <div class="answer-section">
                    <div id="multiple-choice" class="multiple-choice" style="display: none;">
                        <!-- Multiple choice options will be populated here -->
                        <button id="multiple-choice-submit" class="btn" disabled>Submit Answer</button>
                    </div>
                    
                    <div id="text-answer" class="text-answer" style="display: none;">
                        <label for="answer-input">Your answer:</label>
                        <div class="input-group">
                            <input type="text" id="answer-input" placeholder="Type your answer here...">
                            <button id="submit-btn" class="btn" disabled>Submit</button>
                        </div>
                    </div>
                    
                    <div id="feedback" class="feedback" style="display: none;">
                        <div id="result-message" class="result-message"></div>
                        <div id="correct-answer" class="correct-answer"></div>
                        
                        <div class="explanation-container">
                            <button id="show-explanation" class="btn secondary">Show Explanation</button>
                            
                            <div id="explanation" class="explanation" style="display: none;">
                                <h3>Explanation:</h3>
                                <div id="rationale" class="rationale"></div>
                                <div id="author" class="author"></div>
                            </div>
                        </div>
                        
                        <button id="next-btn" class="btn primary">Next Question</button>
                    </div>
                </div>
            </div>
            
            <div id="error" class="error-message" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <p>Failed to load questions. Make sure questions.json exists in the same directory.</p>
                <button id="retry-btn" class="btn">Retry</button>
            </div>
        </main>

        <footer>
            <p>Questions from <a href="https://huggingface.co/datasets/cais/hle" target="_blank">Humanity's Last Exam dataset</a> | <a href="https://github.com/centerforaisafety/HLE" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <script>
    // State management without localStorage
    let questions = [];
    let currentQuestion = null;
    let seenQuestionIds = new Set();
    let userAnswer = '';
    let isAnswered = false;
    let questionsAnswered = 0;
    let correctAnswers = 0;
    let categoryStats = {};
    let categories = new Set();
    let selectedCategory = 'all';
    let popularCategories = [];
    
    // DOM Elements
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error');
    const questionCardElement = document.getElementById('question-card');
    const categoryElement = document.getElementById('category');
    const questionIdElement = document.getElementById('question-id');
    const questionTextElement = document.getElementById('question-text');
    const imageContainerElement = document.getElementById('image-container');
    const questionImageElement = document.getElementById('question-image');
    const multipleChoiceElement = document.getElementById('multiple-choice');
    const multipleChoiceSubmitElement = document.getElementById('multiple-choice-submit');
    const textAnswerElement = document.getElementById('text-answer');
    const answerInputElement = document.getElementById('answer-input');
    const submitButtonElement = document.getElementById('submit-btn');
    const feedbackElement = document.getElementById('feedback');
    const resultMessageElement = document.getElementById('result-message');
    const correctAnswerElement = document.getElementById('correct-answer');
    const showExplanationButtonElement = document.getElementById('show-explanation');
    const explanationElement = document.getElementById('explanation');
    const rationaleElement = document.getElementById('rationale');
    const authorElement = document.getElementById('author');
    const nextButtonElement = document.getElementById('next-btn');
    const questionsCountElement = document.getElementById('questions-count');
    const correctCountElement = document.getElementById('correct-count');
    const accuracyElement = document.getElementById('accuracy');
    const retryButtonElement = document.getElementById('retry-btn');
    const categorySelectElement = document.getElementById('category-select');
    const categoryTagsElement = document.getElementById('category-tags');
    const themeToggleButtonElement = document.getElementById('theme-toggle-btn');

    // Theme Management
    function initTheme() {
        // Use a variable in memory instead of localStorage
        window.darkTheme = true;
    }

    function toggleTheme() {
        window.darkTheme = !window.darkTheme;
        if (window.darkTheme) {
            document.body.classList.remove('light-theme');
        } else {
            document.body.classList.add('light-theme');
        }
    }

    // Fetch questions from local JSON file
    async function fetchQuestions() {
        try {
            showLoading();
            
            try {
                // Try to fetch questions.json first
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error('questions.json not found');
                }
                const data = await response.json();
                processQuestions(data);
            } catch (error) {
                console.error('Error loading questions.json:', error);
                showError();
            }
        } catch (error) {
            console.error('Error in fetchQuestions:', error);
            showError();
        }
    }

    // Process questions data
    function processQuestions(data) {
        if (!Array.isArray(data) || data.length === 0) {
            showError();
            return;
        }
        
        questions = data;
        
        // Extract categories and count their occurrences
        const categoryCount = new Map();
        questions.forEach(q => {
            if (q.category) {
                categories.add(q.category);
                categoryCount.set(q.category, (categoryCount.get(q.category) || 0) + 1);
            }
        });
        
        // Get the most popular categories
        popularCategories = Array.from(categoryCount.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(entry => entry[0]);
        
        // Populate category filter
        populateCategoryFilter();
        
        // Update stats display
        updateStatsDisplay();
        
        // Load random question
        loadRandomQuestion();
    }

    // Populate category filter dropdown and tags
    function populateCategoryFilter() {
        // Populate dropdown
        categorySelectElement.innerHTML = '<option value="all">All Categories</option>';
        
        // Add categories in alphabetical order
        Array.from(categories).sort().forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelectElement.appendChild(option);
        });
        
        // Populate tags for popular categories
        categoryTagsElement.innerHTML = `
            <div class="category-tag ${selectedCategory === 'all' ? 'active' : ''}" data-category="all">All</div>
        `;
        
        popularCategories.forEach(category => {
            const tagElement = document.createElement('div');
            tagElement.className = `category-tag ${selectedCategory === category ? 'active' : ''}`;
            tagElement.dataset.category = category;
            tagElement.textContent = category;
            categoryTagsElement.appendChild(tagElement);
        });
        
        // Add event listeners to category tags
        const categoryTags = categoryTagsElement.querySelectorAll('.category-tag');
        categoryTags.forEach(tag => {
            tag.addEventListener('click', () => {
                selectedCategory = tag.dataset.category;
                categorySelectElement.value = selectedCategory;
                
                // Update active state
                categoryTags.forEach(t => t.classList.remove('active'));
                tag.classList.add('active');
                
                loadRandomQuestion();
            });
        });
    }

    // Load a random question based on selected category
    function loadRandomQuestion() {
        if (questions.length === 0) {
            showError();
            return;
        }

        // Filter questions by selected category
        let filteredQuestions = questions;
        if (selectedCategory !== 'all') {
            filteredQuestions = questions.filter(q => q.category === selectedCategory);
            
            // If no questions in this category, revert to all categories
            if (filteredQuestions.length === 0) {
                filteredQuestions = questions;
                selectedCategory = 'all';
                categorySelectElement.value = 'all';
            }
        }

        // Find questions that haven't been seen yet
        let unseenQuestions = filteredQuestions.filter(q => !seenQuestionIds.has(q.id));
        
        // If all questions have been seen, reset the seen questions set
        if (unseenQuestions.length === 0) {
            seenQuestionIds = new Set();
            unseenQuestions = filteredQuestions;
        }
        
        // Pick a random unseen question
        const randomIndex = Math.floor(Math.random() * unseenQuestions.length);
        currentQuestion = unseenQuestions[randomIndex];
        seenQuestionIds.add(currentQuestion.id);
        
        displayQuestion();
        resetAnswer();
    }

    // Display the current question
    function displayQuestion() {
        // Hide loading and error, show question card
        hideLoading();
        hideError();
        showQuestionCard();
        
        // Set question details
        categoryElement.textContent = currentQuestion.category || 'Uncategorized';
        questionIdElement.textContent = `ID: ${currentQuestion.id}`;
        
        // Set question text and process any LaTeX
        questionTextElement.innerHTML = currentQuestion.question;
        
        // Handle image if present
        if (currentQuestion.image) {
            // Try both extensions
            const imagePath = `images/${currentQuestion.image}`;
            const imagePathPng = imagePath.replace('.jpg', '.png');
            
            // Try PNG first
            questionImageElement.src = imagePathPng;
            
            questionImageElement.onerror = () => {
                // If PNG fails, try JPG or original extension
                questionImageElement.src = imagePath;
                
                questionImageElement.onerror = () => {
                    console.log('Image failed to load:', imagePath);
                    imageContainerElement.style.display = 'none';
                };
            };
            
            questionImageElement.onload = () => {
                imageContainerElement.style.display = 'flex';
            };
            
            // Initially show the container, it will be hidden if the image fails to load
            imageContainerElement.style.display = 'flex';
        } else {
            imageContainerElement.style.display = 'none';
        }
        
        // Handle answer type
        if (currentQuestion.answer_type === 'multipleChoice') {
            displayMultipleChoice();
            textAnswerElement.style.display = 'none';
        } else {
            multipleChoiceElement.style.display = 'none';
            textAnswerElement.style.display = 'block';
        }
        
        // Scroll to the top of the question
        questionCardElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Render LaTeX
        renderMathJax();
    }

    // Process a complex multiple choice option
    function processChoiceContent(choice) {
      // Handle cases where the choice might not be properly formatted
      if (!choice || typeof choice !== 'string' || choice.length < 2) {
          return {
              letter: '?',
              content: choice || 'Unknown option',
              isComplex: false
          };
      }
      
      // Extract the letter and content more reliably
      const letterMatch = choice.match(/^([A-Z])\./i);
      const letter = letterMatch ? letterMatch[1].toUpperCase() : choice.charAt(0);
      
      // Get content after the letter and period
      let content = choice.replace(/^[A-Z]\.\s*/i, '').trim();
      
      // Check if it needs special formatting
      const isComplexChoice = content.length > 100 || content.includes('/') || content.includes('.');
      
      return {
          letter,
          content,
          isComplex: isComplexChoice
      };
  }


    // Display multiple choice options
    function displayMultipleChoice() {
      // Clear previous choices but keep the submit button
      const submitButton = multipleChoiceElement.querySelector('#multiple-choice-submit');
      multipleChoiceElement.innerHTML = '';
      multipleChoiceElement.appendChild(submitButton);
      
      // For text-based multiple choice questions, we'll first try to parse from the question text
      if (!currentQuestion.choices || currentQuestion.choices.length === 0) {
          // Try to automatically parse the choices if they exist in the question text
          const parsedChoices = parseChoicesFromQuestion(currentQuestion.question);
          if (parsedChoices && parsedChoices.length > 0) {
              currentQuestion.choices = parsedChoices;
          } else {
              // If we couldn't parse choices, create basic A-E options
              const choiceLetters = ['A', 'B', 'C', 'D', 'E'];
              currentQuestion.choices = choiceLetters.map(letter => `${letter}. Option ${letter}`);
          }
      }
      
      // Now create the choice elements
      currentQuestion.choices.forEach(choice => {
          const choiceItem = document.createElement('div');
          choiceItem.className = 'choice-item';
          
          // Extract the option letter - it should be at the start of the choice string
          const letterMatch = choice.match(/^([A-Z])\./i);
          if (!letterMatch) return; // Skip if no letter found
          
          const letter = letterMatch[1].toUpperCase();
          choiceItem.dataset.value = letter;
          
          // Get content after the letter and period
          let content = choice.substring(choice.indexOf('.') + 1).trim();
          
          // Check if it's a complex/long option
          const isComplex = content.length > 100 || content.includes('\n');
          if (isComplex) {
              choiceItem.classList.add('long-option');
          }
          
          // Create letter and content elements
          const letterElement = document.createElement('div');
          letterElement.className = 'choice-letter';
          letterElement.textContent = letter + '.';
          
          const contentElement = document.createElement('div');
          contentElement.className = 'choice-content';
          contentElement.innerHTML = content;
          
          // Add elements to the choice item
          choiceItem.appendChild(letterElement);
          choiceItem.appendChild(contentElement);
          
          // Add click event
          choiceItem.addEventListener('click', () => {
              if (!isAnswered) {
                  // Clear any previously selected choices
                  const selectedChoices = multipleChoiceElement.querySelectorAll('.selected');
                  selectedChoices.forEach(selected => selected.classList.remove('selected'));
                  
                  // Select this choice
                  choiceItem.classList.add('selected');
                  userAnswer = letter;
                  
                  // Enable submit button
                  multipleChoiceSubmitElement.disabled = false;
              }
          });
          
          multipleChoiceElement.insertBefore(choiceItem, submitButton);
      });
      
      multipleChoiceElement.style.display = 'block';
  }

  // This function handles parsing choices from the question text
  function parseChoicesFromQuestion(questionText) {
      // First check if the question text contains "Answer Choices:"
      if (!questionText.includes('Answer Choices:')) {
          return null;
      }
      
      // Split the text to get just the choices section
      const parts = questionText.split('Answer Choices:');
      if (parts.length < 2) return null;
      
      const choicesSection = parts[1].trim();
      
      // Find all the option letters in the expected order (A, B, C, etc.)
      const optionLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const result = [];
      
      // For each potential letter option, find its content
      for (let i = 0; i < optionLetters.length; i++) {
          const currentLetter = optionLetters[i];
          const nextLetter = i < optionLetters.length - 1 ? optionLetters[i+1] : null;
          
          // Look for this option in the text - be specific about format to avoid false matches
          // Match at word boundary or beginning of line to avoid matching partial words
          const letterPattern = new RegExp(`(^|\\n|\\s)${currentLetter}\\.\\s`, 'm');
          const letterMatch = choicesSection.match(letterPattern);
          
          if (!letterMatch) {
              // If we don't find this letter, we've likely reached the end of the options
              break;
          }
          
          // Find where this option starts
          const startIndex = letterMatch.index + letterMatch[0].indexOf(currentLetter);
          
          // Find where this option ends (either at the next option or end of text)
          let endIndex = choicesSection.length;
          if (nextLetter) {
              const nextLetterPattern = new RegExp(`(^|\\n|\\s)${nextLetter}\\.\\s`, 'm');
              const nextLetterMatch = choicesSection.match(nextLetterPattern);
              if (nextLetterMatch) {
                  endIndex = nextLetterMatch.index + nextLetterMatch[0].indexOf(nextLetter);
              }
          }
          
          // Extract the option's text
          if (startIndex < endIndex) {
              const optionText = choicesSection.substring(startIndex, endIndex).trim();
              result.push(optionText);
          }
      }
      
      return result;
  }


    // Reset answer state
    function resetAnswer() {
        userAnswer = '';
        isAnswered = false;
        
        // Reset input field
        answerInputElement.value = '';
        answerInputElement.disabled = false;
        
        // Reset submit buttons
        submitButtonElement.disabled = true;
        submitButtonElement.style.display = 'block';
        multipleChoiceSubmitElement.disabled = true;
        
        // Hide feedback
        feedbackElement.style.display = 'none';
        explanationElement.style.display = 'none';
        
        // Reset explanation button text
        showExplanationButtonElement.textContent = 'Show Explanation';

        // Focus the answer input (for text answers)
        if (textAnswerElement.style.display !== 'none') {
            setTimeout(() => {
                answerInputElement.focus();
            }, 300);
        }
    }

    // Check the user's answer
    function checkAnswer() {
        if (!currentQuestion) return;
        
        let correct = false;
        
        if (currentQuestion.answer_type === 'multipleChoice') {
            correct = userAnswer.toUpperCase() === currentQuestion.answer.toUpperCase();
        } else {
            const normalizedUserAnswer = userAnswer.trim().toLowerCase();
            const normalizedCorrectAnswer = currentQuestion.answer.toLowerCase();
            correct = normalizedUserAnswer === normalizedCorrectAnswer;
        }
        
        isAnswered = true;
        questionsAnswered++;
        if (correct) {
            correctAnswers++;
            
            // Update category stats
            const category = currentQuestion.category || 'Uncategorized';
            categoryStats[category] = categoryStats[category] || { total: 0, correct: 0 };
            categoryStats[category].total = (categoryStats[category].total || 0) + 1;
            categoryStats[category].correct = (categoryStats[category].correct || 0) + 1;
        } else {
            // Update category stats for incorrect answers
            const category = currentQuestion.category || 'Uncategorized';
            categoryStats[category] = categoryStats[category] || { total: 0, correct: 0 };
            categoryStats[category].total = (categoryStats[category].total || 0) + 1;
        }
        
        // Update stats display
        updateStatsDisplay();
        
        // Display feedback
        showFeedback(correct);
    }

    // Update stats display
    function updateStatsDisplay() {
        questionsCountElement.textContent = questionsAnswered;
        correctCountElement.textContent = correctAnswers;
        const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;
        accuracyElement.textContent = `${accuracy}%`;
    }

    // Show feedback after answering
    function showFeedback(isCorrect) {
        // Hide submit button
        submitButtonElement.style.display = 'none';
        multipleChoiceSubmitElement.style.display = 'none';
        
        // Disable input
        answerInputElement.disabled = true;
        
        // Show feedback
        feedbackElement.style.display = 'block';
        
        // Set result message
        resultMessageElement.textContent = isCorrect ? 'Correct!' : 'Incorrect!';
        resultMessageElement.className = isCorrect ? 'result-message correct' : 'result-message incorrect';
        
        // Set correct answer
        correctAnswerElement.innerHTML = `<strong>Correct answer:</strong> ${currentQuestion.answer}`;
        
        // Set rationale
        rationaleElement.innerHTML = currentQuestion.rationale || 'No explanation provided.';
        
        // Set author if available
        if (currentQuestion.author_name) {
            authorElement.textContent = `Question by: ${currentQuestion.author_name}`;
            authorElement.style.display = 'block';
        } else {
            authorElement.style.display = 'none';
        }
        
        // Highlight correct answer for multiple choice
        if (currentQuestion.answer_type === 'multipleChoice') {
            const choices = multipleChoiceElement.querySelectorAll('.choice-item');
            choices.forEach(choice => {
                if (choice.dataset.value.toUpperCase() === currentQuestion.answer.toUpperCase()) {
                    choice.classList.add('correct');
                } else if (choice.classList.contains('selected')) {
                    choice.classList.add('incorrect');
                }
            });
        }
        
        // Render LaTeX in feedback
        renderMathJax();
    }

    // Enhanced MathJax rendering function
    function renderMathJax() {
        // Wait for content to be in the DOM
        setTimeout(() => {
            if (window.MathJax) {
                try {
                    // Tell MathJax to typeset the entire document
                    window.MathJax.typesetPromise()
                        .then(() => {
                            console.log('MathJax typesetting complete');
                        })
                        .catch((err) => {
                            console.error('MathJax typesetting failed:', err);
                        });
                } catch (error) {
                    console.error('Error rendering MathJax:', error);
                }
            } else {
                console.warn('MathJax not loaded yet');
            }
        }, 100);
    }

    // Show/hide UI elements
    function showLoading() {
        loadingElement.style.display = 'flex';
        errorElement.style.display = 'none';
        questionCardElement.style.display = 'none';
    }

    function hideLoading() {
        loadingElement.style.display = 'none';
    }

    function showError() {
        loadingElement.style.display = 'none';
        errorElement.style.display = 'flex';
        questionCardElement.style.display = 'none';
    }

    function hideError() {
        errorElement.style.display = 'none';
    }

    function showQuestionCard() {
        questionCardElement.style.display = 'block';
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize theme
        initTheme();
        
        // Fetch questions when page loads
        fetchQuestions();
        
        // Listen for text input changes
        answerInputElement.addEventListener('input', (event) => {
            userAnswer = event.target.value.trim();
            submitButtonElement.disabled = userAnswer === '';
        });
        
        // Submit button click
        submitButtonElement.addEventListener('click', () => {
            checkAnswer();
        });
        
        // Multiple choice submit button click
        multipleChoiceSubmitElement.addEventListener('click', () => {
            checkAnswer();
        });
        
        // Enter key in text input
        answerInputElement.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && userAnswer.trim() !== '') {
                checkAnswer();
            }
        });
        
        // Show/hide explanation
        showExplanationButtonElement.addEventListener('click', () => {
            if (explanationElement.style.display === 'none') {
                explanationElement.style.display = 'block';
                showExplanationButtonElement.textContent = 'Hide Explanation';
            } else {
                explanationElement.style.display = 'none';
                showExplanationButtonElement.textContent = 'Show Explanation';
            }
        });
        
        // Next question button
        nextButtonElement.addEventListener('click', () => {
            loadRandomQuestion();
        });
        
        // Retry button
        retryButtonElement.addEventListener('click', () => {
            fetchQuestions();
        });
        
        // Category filter change
        categorySelectElement.addEventListener('change', (event) => {
            selectedCategory = event.target.value;
            
            // Update category tags
            const categoryTags = categoryTagsElement.querySelectorAll('.category-tag');
            categoryTags.forEach(tag => {
                tag.classList.toggle('active', tag.dataset.category === selectedCategory);
            });
            
            loadRandomQuestion();
        });
        
        // Theme toggle
        themeToggleButtonElement.addEventListener('click', () => {
            toggleTheme();
        });
        
        // Add keypress shortcuts
        document.addEventListener('keydown', (event) => {
            // Press 'n' for next question when feedback is shown
            if (event.key === 'n' && feedbackElement.style.display === 'block') {
                loadRandomQuestion();
            }
            
            // Press 'e' to toggle explanation when feedback is shown
            if (event.key === 'e' && feedbackElement.style.display === 'block') {
                showExplanationButtonElement.click();
            }
        });
    });
    </script>
</body>
</html>
